{
  "Name": "TA 1304 Rate limit count by header",
  "Skip": false,
  "Tests": [
    {
      "Name": "Step 1 - same value",
      "Skip": false,
      "Steps": [
        {
          "Name": "User can create rate limit with name `header_test`",
          "Skip": false,
          "GenerateID": false,
          "API": {
            "Base": "rate-limit",
            "Path": ""
          },
          "Method": "POST",
          "Payload": {
            "Params": [
              {
                "Key": "name",
                "Value": "\"header_test\""
              },
              {
                "Key": "id",
                "Value": "\"header_test\""
              },
              {
                "Key": "global",
                "Value": "false"
              },
              {
                "Key": "active",
                "Value": "true"
              },
              {
                "Key": "threshold",
                "Value": "3"
              },
              {
                "Key": "timeframe",
                "Value": "15"
              },
              {
                "Key": "action",
                "Value": "\"action-rate-limit-block\""
              },
              {
                "Key": "key",
                "Value": "[{\"headers\":\"os\"}]"
              }
            ]
          },
          "Expected": {
            "Code": "200",
            "Type": "json",
            "Single": true,
            "SingleResult": [
              {
                "Key": "ok",
                "Value": true
              }
            ]
          }
        },
        {
          "Name": "User can create security policy and add rate limit `header_test` to security policy",
          "Skip": false,
          "GenerateID": false,
          "API": {
            "Base": "security-policy",
            "Path": ""
          },
          "Method": "POST",
          "Payload": {
            "Params": [
              {
                "Key": "id",
                "Value": "\"test-sp\""
              },
              {
                "Key": "name",
                "Value": "\"test-sp\""
              },
              {
                "Key": "map",
                "Value": "[{\"id\": \"__root_entry__\", \"name\": \"__root__\", \"match\": \"^/(\\\\W.*)?$\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": [\"header_test\"]},{ \"id\": \"__default_entry__\", \"name\": \"__default__\", \"match\": \"/\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": []}]"
              }
            ]
          },
          "Expected": {
            "Code": "200",
            "Type": "json",
            "Single": true,
            "SingleResult": [
              {
                "Key": "ok",
                "Value": true
              }
            ]
          }
        },
        {
          "Name": "Create new server group 'test.site' ",
          "Skip": false,
          "GenerateID": false,
          "API": {
            "Base": "server-group",
            "Path": "test-site/"
          },
          "Method": "POST",
          "Payload": {
            "Params": [
              {
                "Key": "id",
                "Value": "\"test-site\""
              },
              {
                "Key": "name",
                "Value": "\"test-site\""
              },
              {
                "Key": "server_names",
                "Value": "[\"test.site\"]"
              },
              {
                "Key": "security_policy",
                "Value": "\"test-sp\""
              }
            ]
          },
          "Expected": {
            "Code": "201",
            "Type": "json",
            "Single": true,
            "SingleResult": [
              {
                "Key": "id",
                "Value": "test-site"
              }
            ]
          }
        },
        {
          "ID": "publish-changes",
          "Skip": false
        },
        {
          "ID": "wait-for-publish",
          "Skip": false
        },
        {
          "Name": "Send Traffic 1 to rate limit `header_test` with host `test.site`",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=something"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "Name": "Send Traffic 2 to rate limit `header_test` with host `test.site`",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=something"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "Name": "Send Traffic 3 to rate limit `header_test` with host `test.site`",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=something"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "Name": "Send Traffic 4 to rate limit `header_test` with host `test.site`",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=something"
            }
          ],
          "Expected": {
            "Code": "471",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "ID": "wait-for-logs",
          "Skip": false
        },
        {
          "Name": "Get Logs",
          "Skip": false,
          "API": {
            "Base": "logs",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "syntax",
              "Value": "string_query"
            }
          ],
          "Arguments": [
            {
              "Key": "filters",
              "Value": "status != 403, timestamp between @@NOW(-3minutes)@@ and @@NOW(+2minutes)@@, branch=@@branch@@"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "jsonpath",
            "Single": true,
            "Headers": [
              {
                "Key": "Server",
                "Value": "rhino-core-shield"
              }
            ],
            "SingleResult": [
              {
                "Key": "data/results/0/tags/*",
                "Value": "status:200"
              },
              {
                "Key": "data/results/1/tags/*",
                "Value": "status:200"
              },
              {
                "Key": "data/results/2/tags/*",
                "Value": "status:200"
              },
              {
                "Key": "data/results/3/tags/*",
                "Value": "status:471"
              },
              {
                "Key": "data/results/3/tags/*",
                "Value": "limit-name:rl-test"
              },
              {
                "Key": "data/results/3/reason",
                "Value": "Block - rate limit threshold=3 - rl_test - [request]"
              },
              {
                "Key": "data/results/3/rl_triggers/0/action",
                "Value": "block"
              }
            ]
          }
        }
      ]
    },
    {
      "Name": "different cookie value",
      "Skip": false,
      "Steps": [
        {
          "Name": "Wait for rate limit time frame",
          "Skip": false
        },
        {
          "Name": "Send Traffic 1 request",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=something"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "Name": "Send Traffic 2 request",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=something"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "Name": "Send Traffic 3 request",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=linux"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        },
        {
          "Name": "Send Traffic 4 request",
          "Skip": false,
          "API": {
            "Base": "send-traffic",
            "Path": ""
          },
          "Method": "GET",
          "Headers": [
            {
              "Key": "Host",
              "Value": "test.site"
            },
            {
              "Key": "Cookie",
              "Value": "os=linux"
            }
          ],
          "Expected": {
            "Code": "200",
            "Type": "content",
            "Single": true,
            "Text": "b''"
          }
        }
      ]
    }
  ]
}