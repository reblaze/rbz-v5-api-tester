{
   "Name":"TA 1303 Rate limit actions",
   "Skip": false,
   "Tests":[
      {
         "Name":"Add Security policy",
         "Skip":false,
         "Steps":[
            {
               "Name":"User can add security policy to new rate limit",
               "Skip":false,
               "GenerateID":false,
               "API":{
                  "Base":"security-policy",
                  "Path":"__default__/"
               },
               "Method":"PUT",
               "Payload":{
                  "Params":[
                     {
                        "Key":"id",
                        "Value":"\"__default__\""
                     },
                     {
                        "Key":"map",
                        "Value":"[{\"id\": \"__root_entry__\", \"name\": \"__root__\", \"match\": \"^/(\\\\W.*)?$\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": []},{ \"id\": \"__default_entry__\", \"name\": \"__default__\", \"match\": \"/\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": []},{\"id\": \"test_sp\", \"name\": \"name\", \"match\": \"/test\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": []}]"
                     }
                  ]
               },
               "Expected":{
                  "Code":"200",
                  "Type":"json",
                  "Single":true,
                  "SingleResult":[
                     {
                        "Key":"ok",
                        "Value":true
                     }
                  ]
               }
            },
            {
               "Name":"User can create a rate limit with name `Action default`",
               "Skip":false,
               "GenerateID":false,
               "API":{
                  "Base":"rate-limit",
                  "Path":""
               },
               "Method":"POST",
               "Payload":{
                  "Params":[
                     {
                        "Key":"name",
                        "Value":"\"actiondefault\""
                     },
                     {
                        "Key":"id",
                        "Value":"\"action_default\""
                     },
                     {
                        "Key":"description",
                        "Value":"\"Action default\""
                     },
                     {
                        "Key":"global",
                        "Value":"true"
                     },
                     {
                        "Key":"active",
                        "Value":"false"
                     },
                     {
                        "Key":"threshold",
                        "Value":"1"
                     },
                     {
                        "Key":"timeframe",
                        "Value":"10"
                     },
                     {
                        "Key":"key",
                        "Value":"[{\"attrs\":\"ip\"}]"
                     },
                     {
                        "Key":"action",
                        "Value":"\"action-rate-limit-block\""
                     }
                  ]
               },
               "Expected":{
                  "Code":"200",
                  "Type":"json",
                  "Single":true,
                  "SingleResult":[
                     {
                        "Key":"ok",
                        "Value":true
                     }
                  ]
               }
            },
            {
               "Name":"User can add `test` security policy to new rate limit",
               "Skip":false,
               "GenerateID":false,
               "API":{
                  "Base":"security-policy",
                  "Path":"__default__/"
               },
               "Method":"PUT",
               "Payload":{
                  "Params":[
                     {
                        "Key":"id",
                        "Value":"\"__default__\""
                     },
                     {
                        "Key":"map",
                        "Value":"[{\"id\": \"__root_entry__\", \"name\": \"__root__\", \"match\": \"^/(\\\\W.*)?$\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": []},{ \"id\": \"__default_entry__\", \"name\": \"__default__\", \"match\": \"/\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": []},{\"id\": \"test_sp\", \"name\": \"name\", \"match\": \"/test\", \"acl_profile\": \"__acldefault__\", \"acl_active\": true, \"backend_id\": \"__default__\", \"cloud_functions\": [], \"content_filter_profile\": \"__defaultcontentfilter__\", \"content_filter_active\": true, \"limit_ids\": [\"action_default\"]}]"
                     }
                  ]
               },
               "Expected":{
                  "Code":"200",
                  "Type":"json",
                  "Single":true,
                  "SingleResult":[
                     {
                        "Key":"ok",
                        "Value":true
                     }
                  ]
               }
            },
            {
                    "Name": "Create new server group 'test.site' with security policy 'test-sp'",
                    "Skip": false,
                    "GenerateID": false,
                    "API":
                    {
                        "Base": "server-group",
                        "Path": "test-site/"
                    },
                    "Method" :"POST",
                    "Payload":
                    {
                        "Template": "servergroup.template",
                        "Defaults": "servergroup.defaults",
                        "Params":
                        [
                            {
                                "Key": "id",
                                "Value": "\"test-site\""
                            },
                            {
                                "Key": "name",
                                "Value": "\"test-site\""
                            },
                            {
                                "Key": "server_names",
                                "Value": "[\"test.site\"]"
                            },
                            {
                                "Key": "security_policy",
                                "Value": "\"test\""
                            }
                        ]
                    },
                    "Expected":
                    {
                        "Code": "201",
                        "Type": "json",
						"Single": true,
                        "SingleResult":
                        [
                            {
                                "Key": "id",
                                "Value": "test-site"
                            }
                        ]
                    }
            },
            {
                    "Name": "Wait for Publish changes to take affect",
                    "Skip": false,
                    "Python": true,
                    "Code":
                    [
                        "import time",
                        "time.sleep(30)"
                    ]
                },
             {
                    "ID": "wait-for-publish",
                    "Skip": false
                },
            {
                    "ID": "publish-changes",
                    "Skip": false
                },
            {
               "Name":"Send Traffic - request 1 ",
               "Skip":true,
               "GenerateID":false,
               "Traffic":true,
               "Method":"GET",
               "Headers":[
                  {
                     "Key":"Host",
                     "Value":"test.site"
                  }
               ],
               "Expected":{
                  "Code":"200",
                  "Type":"content",
                  "Single":true,
                  "Text":"b''"
               }
            },
            {
               "Name":"Send Traffic - request 2",
               "Skip":true,
               "GenerateID":false,
               "Traffic":true,
               "Method":"GET",
               "Headers":[
                  {
                     "Key":"Host",
                     "Value":"test.site"
                  },
                  {
                     "Key":"Cookie",
                     "Value":"os=something"
                  }
               ],
               "Expected":{
                  "Code":"200",
                  "Type":"content",
                  "Single":true,
                  "Text":"b''"
               }
            }
         ]
      }
   ]
}